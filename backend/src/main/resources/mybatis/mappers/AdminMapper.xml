<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.boot.dao.AdminDAO">

	<resultMap id="userMap" type="com.boot.dto.UserInfoDTO">
	    <result property="email" column="EMAIL"/>
	    <result property="firstName" column="FIRST_NAME"/>
	    <result property="lastName" column="LAST_NAME"/>
	    <result property="fullName" column="FULL_NAME"/>
	
	    <result property="password" column="PASSWORD"/>
	    <result property="provider" column="PROVIDER"/>
	    <result property="role" column="ROLE"/>
	
	    <result property="createdAt" column="CREATED_AT"/>
	    <result property="loginFailCount" column="LOGIN_FAIL_COUNT"/>
	    <result property="lockUntil" column="LOCK_UNTIL"/>
	    <result property="resetToken" column="RESET_TOKEN"/>
	    <result property="tokenExpireAt" column="TOKEN_EXPIRE_AT"/>
	    <result property="accountStatus" column="ACCOUNT_STATUS"/>
	    <result property="suspendUntil" column="SUSPEND_UNTIL"/>
	    <result property="refreshToken" column="REFRESH_TOKEN"/>
	</resultMap>
    <!-- 전체 사용자 조회 -->
    <select id="getUsers" resultMap="userMap">
	    SELECT 
	        EMAIL,
	        FULL_NAME,
	        ROLE,
	        PROVIDER,
	        ACCOUNT_STATUS,
	        IS_SUSPENDED,
	        TO_CHAR(SUSPEND_UNTIL, 'YYYY-MM-DD HH24:MI:SS') AS SUSPEND_UNTIL,
	        LOGIN_FAIL_COUNT,
	        SUSPEND_REASON,
	        TO_CHAR(LOCK_UNTIL, 'YYYY-MM-DD HH24:MI:SS') AS LOCK_UNTIL,
	        TO_CHAR(CREATED_AT, 'YYYY-MM-DD HH24:MI:SS') AS CREATED_AT
	    FROM USER_INFO
	    ORDER BY CREATED_AT DESC
	</select>
	
	<!-- 2) 계정 정지 -->
    <update id="suspendUser">
        UPDATE USER_INFO
        SET
            IS_SUSPENDED = 'Y',
            SUSPEND_UNTIL = TO_DATE(#{until}, 'YYYY-MM-DD HH24:MI:SS'),
            SUSPEND_REASON = #{reason}
        WHERE EMAIL = #{email}
    </update>

    <!-- 3) 계정 정지 해제 -->
    <update id="unsuspendUser">
        UPDATE USER_INFO
        SET
            IS_SUSPENDED = 'N',
            SUSPEND_UNTIL = NULL,
            SUSPEND_REASON = NULL
        WHERE EMAIL = #{email}
    </update>

	<!-- 사용자 조회 -->
	<select id="findUserByEmail" resultMap="userMap">
	    SELECT 
	        EMAIL,
	        FIRST_NAME,
	        LAST_NAME,
	        FULL_NAME,
	        PASSWORD,
	        PROVIDER,
	        ROLE,
	        TO_CHAR(CREATED_AT, 'YYYY-MM-DD HH24:MI:SS') AS CREATED_AT,
	        LOGIN_FAIL_COUNT,
	        TO_CHAR(LOCK_UNTIL, 'YYYY-MM-DD HH24:MI:SS') AS LOCK_UNTIL,
	        RESET_TOKEN,
	        TO_CHAR(TOKEN_EXPIRE_AT, 'YYYY-MM-DD HH24:MI:SS') AS TOKEN_EXPIRE_AT,
	        ACCOUNT_STATUS,
	        IS_SUSPENDED,
	        TO_CHAR(SUSPEND_UNTIL, 'YYYY-MM-DD HH24:MI:SS') AS SUSPEND_UNTIL,
	        SUSPEND_REASON,
	        REFRESH_TOKEN
	    FROM USER_INFO
	    WHERE EMAIL = #{email}
	</select>
	
	<!-- 권한 변경 -->
	<update id="updateUserRole">
	    UPDATE USER_INFO
	    SET ROLE = #{role}
	    WHERE EMAIL = #{email}
	</update>

	<!-- 로그인 실패 초기화 -->
    <update id="resetLoginFail">
        UPDATE USER_INFO
        SET LOGIN_FAIL_COUNT = 0,
        LOCK_UNTIL = NULL
        WHERE EMAIL = #{email}
    </update>

	<!-- 강제 로그아웃 -->
    <update id="forceLogout">
        UPDATE USER_INFO
        SET REFRESH_TOKEN = NULL
        WHERE EMAIL = #{email}
    </update>

	<!-- Refresh Token 목록 -->
    <select id="getTokens" resultType="map">
        SELECT 
	        EMAIL,
	        REFRESH_TOKEN,
	        TO_CHAR(CREATED_AT, 'YYYY-MM-DD HH24:MI:SS') AS CREATED_AT
	    FROM USER_INFO
	    WHERE REFRESH_TOKEN IS NOT NULL
	    ORDER BY CREATED_AT DESC
    </select>

	<!-- 특정 사용자 Refresh Token 삭제 -->
	<update id="deleteRefreshToken">
	    UPDATE USER_INFO
	    SET REFRESH_TOKEN = NULL
	    WHERE EMAIL = #{email}
	</update>

	<!-- 전체 Refresh Token 초기화 -->
    <update id="clearAllTokens">
	    UPDATE USER_INFO
	    SET REFRESH_TOKEN = NULL
	    WHERE REFRESH_TOKEN IS NOT NULL
	</update>

	<!-- 로그인 로그 -->
    <select id="getLoginLog" resultType="map">
	    SELECT
	        LOG_ID,
	        EMAIL,
	        STATUS,
	        IP_ADDRESS,
	        USER_AGENT,
	        TO_CHAR(CREATED_AT, 'YYYY-MM-DD HH24:MI:SS') AS CREATED_AT
	    FROM LOGIN_LOG
	    ORDER BY LOG_ID DESC
	</select>

	<!-- 관리자 로그 -->
	<select id="getAdminLog" resultType="map">
	    SELECT
	        LOG_ID,
	        ADMIN_EMAIL,
	        TARGET_EMAIL,
	        ACTION,
	        DETAIL,
	        TO_CHAR(CREATED_AT, 'YYYY-MM-DD HH24:MI:SS') AS CREATED_AT
	    FROM ADMIN_LOG
	    ORDER BY LOG_ID DESC
	</select>

	<!-- 대시보드 상단 요약 -->
    <select id="getDashboardSummary"
            resultType="com.boot.dto.DashboardSummaryDTO">
        SELECT
            (SELECT COUNT(*) FROM USER_INFO) AS totalUsers,
            (SELECT COUNT(*) FROM USER_INFO WHERE ACCOUNT_STATUS = 'ACTIVE') AS activeUsers,
            (SELECT COUNT(*) FROM USER_INFO WHERE IS_SUSPENDED = 'Y') AS suspendedUsers,
            (SELECT COUNT(*) FROM USER_INFO WHERE ACCOUNT_STATUS = 'WAITING_VERIFY') AS waitingVerifyUsers,
            (SELECT COUNT(*) FROM USER_INFO WHERE LOGIN_FAIL_COUNT >= 3) AS dangerUsers,
            (SELECT COUNT(*) FROM STOCK_INFO) AS totalStocks,
            (SELECT COUNT(*) FROM STOCK_NEWS) AS totalNews
        FROM dual
    </select>

    <!-- 최근 N일 일별 가입자 수 -->
    <select id="getDailyJoins"
            parameterType="int"
            resultType="com.boot.dto.DailyUserJoinDTO">
        SELECT
            TO_CHAR(CREATED_AT, 'YYYY-MM-DD') AS joinDate,
            COUNT(*) AS count
        FROM USER_INFO
        WHERE CREATED_AT >= TRUNC(SYSDATE) - #{days}
        GROUP BY TO_CHAR(CREATED_AT, 'YYYY-MM-DD')
        ORDER BY joinDate
    </select>

    <!-- 최근 N일 로그인 STATUS 통계 -->
    <select id="getLoginStatusStats"
            parameterType="int"
            resultType="com.boot.dto.LoginStatusStatDTO">
        SELECT
            STATUS AS status,
            COUNT(*) AS count
        FROM LOGIN_LOG
        WHERE CREATED_AT >= TRUNC(SYSDATE) - #{days}
        GROUP BY STATUS
        ORDER BY STATUS
    </select>

    <!-- 최근 N일 뉴스 많은 종목 TOP N -->
    <select id="getTopNewsStocks"
            resultType="com.boot.dto.StockNewsTopDTO">
        SELECT *
		FROM (
		    SELECT 
		        n.STOCK_CODE AS stockCode,
		        s.STOCK_NAME AS stockName,
		        COUNT(*) AS newsCount
		    FROM STOCK_NEWS n
		    JOIN STOCK_INFO s 
		        ON n.STOCK_CODE = s.STOCK_CODE
		    WHERE n.NEWS_DATE >= TRUNC(SYSDATE) - 7
		    GROUP BY n.STOCK_CODE, s.STOCK_NAME
		    ORDER BY newsCount DESC
		)
		<![CDATA[
		WHERE ROWNUM <= 5
		]]>
    </select>

    <!-- 관리자 로그 기록 -->
    <insert id="insertAdminLog">
        INSERT INTO ADMIN_LOG (
            ADMIN_EMAIL,
            TARGET_EMAIL,
            ACTION,
            DETAIL,
            CREATED_AT
        ) VALUES (
            #{adminEmail},
            #{targetEmail, jdbcType=VARCHAR},
            #{action},
            #{detail},
            SYSDATE
        )
    </insert>

</mapper>
